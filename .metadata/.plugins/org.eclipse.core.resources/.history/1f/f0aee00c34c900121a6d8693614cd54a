/*
 * RS232_1.h
 *
 *  Created on: 16.04.2013
 *      Author: maschood
 */

#ifndef RS232_1_H_
#define RS232_1_H_

#define MASSAGESIZE 1

#include <fcntl.h>
#include <termios.h>
#include <errno.h>
#include "HWaccess.h"

#include "HAWThread/HAWThread.h"
#include "Mutex/Mutex.h"

//#define DEBUG_RS232
#define DEV_SER1 "/dev/ser1"

#define MSG_TEST 	'a'
#define MSG_TIMEOUT	0

class RS232_1: public thread::HAWThread {
private:


	int buffer [1000];

	void* buf = NULL;



	/**
	 * instance for /dev/ser1 (singleton)
	 */
	static RS232_1* instance;

	/**
	 * mutex for securing access to RS232 instance
	 */
	static Mutex* RS232InstanceMutex;

	/**
	 * filedescriptor for /dev/ser1, returned by open() function
	 */
	int fd;

	/**
	 * recv-buffer for the readcond function
	 */
	char recvbuf;

	/**
	 * default private constructor for singleton pattern.
	 * opens and initializes the serial port via the termios
	 * struct.
	 */
	RS232_1();

public:

	/**
	 * Function returns an instance of the RS232_1-class. Class is
	 * using singleton pattern, so only one instance for access to
	 * the serial-port 1 exists.
	 * @return instance for serial1
	 */
	static RS232_1* getInstance();

	/**
	 * standard destructor, deletes instance and mutexes for serial1
	 * and closes the device.
	 */
	virtual ~RS232_1();

	/**
	 * send a message on serial1
	 * @param msg control message, will be defined later
	 * @return number of bytes send, or -1 if sending failed
	 */
	int sendMsg(void* buf);

	/**
	 * read a message on serial1
	 * @param rbuf receive buffer, msg will be stored to this buf
	 * @return number of bytes read, or 0 if timeout occured, or -1 if error ocured
	 */
	int readMsg(void* rbuf);

	/**
	 * example implementation of a reading thread, this class is derived from HAWThread.
	 * this function reads from serial1 and also interprets the recved messages
	 * and executes the related commands.
	 */
	virtual void execute(void* arg);

	/**
	 * needs to be implemented, no functionality in here. closing of the
	 * device file is done in the destructor.
	 */
	virtual void shutdown();
};
#endif /* RS232_1_H_ */



